# CH32V208 NFC双晶振低功耗检卡操作例程

本readme采用markdown语法。如果离线查看，推荐使用`VSCode`，配合`Markdown Preview Enhanced`插件进行预览，即可阅读查看。

本工程对应原理图为[**CH32V208W-NFC**](../Sch&PCB/CH32V208W-NFC)

## CH32V208 NFC原理概述

NFC操作代码位于工程目录中`Drivers/NFC_Reader`目录下。

NFC硬件底层使用了一个高级定时器，一个通用定时器，一个DMA通道。

高级定时器做为主定时器，通用定时器做为从定时器。在主定时器每个周期PWM波发出后，从定时器计数值+1，达到从定时器设定的周期值后，进入从定时器中断。在通用定时器中断中，通过修改寄存器`CHCTLRx`，对高级定时器产生的PWM输出进行开关。

DMA通道为该通用定时器更新事件所对应的DMA通道。

在波形发送完成后，通用定时器切换到接收模式，进行接收。

## NFC LPCD低功耗检测卡实现原理

LPCD低功耗检卡是在蓝牙周期性广播后，使用通过`96Mhz`主频分出的不标准的`13.71Mhz`波形往天线发送，然后检测放大器正向输入引脚的平均ADC值。
所以芯片集成放大器的正向输入端必须也是ADC采集端口，以满足使用ADC采集能量信号来判断是否有卡接近。
不同的天线，电路板可能值不同，所以需要有阈值校准操作。

## 硬件相关注意事项

硬件相关注意事项请查看[硬件设计](./docs/hardware.md)

## 软件相关注意事项

软件相关注意事项请查看[软件设计](./docs/software.md)

## 操作示例

`NFC_Reader_M1.c`中为NFC M1卡操作库。

`NFC_Reader.c`中为NFC代码操作示例。

在`NFC_Reader.c`中演示了常用的读卡号、选中卡、读、写、扣款、充值等操作。

## 通讯测试

针对本方案所进行的一些测试请查看[测试汇总](./docs/test-report.md)
